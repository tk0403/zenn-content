---
title: "Chached Table"
emoji: "ðŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["TiDB"]
published: false
---

# ã¯ã˜ã‚ã«
# åˆ¶ç´„
## äº‹å‰æº–å‚™
```sql
create database test2;
use test2;
create table t1 (id int not null primary key auto_increment, text longtext);
ALTER TABLE t1 CACHE;
INSERT INTO t2 (text) VALUES (CONCAT(REPEAT('a', 6291400), 'xyz')); -- about 10 times
select id, CHAR_LENGTH(text) as textcounts from t1;
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«åŒ–ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§64MiBä»¥ä¸Šã®å ´åˆ
```sql
create database test2;
use test2;
create table t2 (id int not null primary key auto_increment, text longtext);
INSERT INTO t2 (text) VALUES (CONCAT(REPEAT('a', 6291400), 'xyz')); -- about 10 times
select id, CHAR_LENGTH(text) as textcounts from t1;
```
`ALTER TABLE t2 CACHE;`ã‚’å®Ÿæ–½
```sql
mysql> analyze table t1, t2;
mysql> show table status;
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time | Check_time | Collation   | Checksum | Create_options | Comment |
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
| t1   | InnoDB |      10 | Compact    |   11 |        1048591 |    11534501 |               0 |            0 |         0 |             14 | 2024-02-13 07:15:27 | NULL        | NULL       | utf8mb4_bin |          | cached=on      |         |
| t2   | InnoDB |      10 | Compact    |   11 |        6291415 |    69205565 |               0 |            0 |         0 |             14 | 2024-02-13 07:17:42 | NULL        | NULL       | utf8mb4_bin |          |                |         |
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
2 rows in set (0.01 sec)

mysql> ALTER TABLE t2 CACHE;
ERROR 8242 (HY000): 'table too large' is unsupported on cache tables.
mysql> 
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERTï¼ˆãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§64MiBåˆ¶ç´„ã‚’è¶…ãˆã‚‹ï¼‰
```sql
mysql> select id, CHAR_LENGTH(text) as textcounts from t2;
+----+------------+
| id | textcounts |
+----+------------+
|  3 |    6291403 |
|  4 |    6291403 |
|  5 |    6291403 |
|  6 |    6291403 |
|  7 |    6291403 |
|  8 |    6291403 |
|  9 |    6291403 |
| 10 |    6291403 |
| 11 |    6291403 |
| 12 |    6291403 |
+----+------------+
10 rows in set (0.42 sec)

mysql> analyze table t1, t2;
Query OK, 0 rows affected, 2 warnings (0.55 sec)

mysql> show table status;
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time | Check_time | Collation   | Checksum | Create_options | Comment |
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
| t1   | InnoDB |      10 | Compact    |   11 |        1048591 |    11534501 |               0 |            0 |         0 |             14 | 2024-02-13 07:15:27 | NULL        | NULL       | utf8mb4_bin |          | cached=on      |         |
| t2   | InnoDB |      10 | Compact    |   10 |        6291415 |    62914150 |               0 |            0 |         0 |             14 | 2024-02-13 07:17:42 | NULL        | NULL       | utf8mb4_bin |          |                |         |
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
2 rows in set (0.01 sec)

mysql> ALTER TABLE t2 CACHE;
Query OK, 0 rows affected (0.77 sec)
```

`show table status`ã ã¨ãªãœã‹å°‘ã—ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºå¢—ãˆã¦ã¾ã™ï¼ˆ64MiBã‚‚è¶…ãˆã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ï¼‰ãŒã€ãã‚‚ãã‚‚ã“ã®å€¤ã¯æ­£ç¢ºã§ã¯ãªã„ã®ã§ã€ã ã„ãŸã„ãã‚Œãã‚‰ã„ã€ã¨ã„ã†ç†è§£ã§è‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚
â€»ã„ãšã‚Œã«ã›ã‚ˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ãªã‚Šã¾ã™ã€‚
`ALTER TABLE t2 CACHE;`ã‚’å®Ÿæ–½
```sql
mysql> show table status;
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
| Name | Engine | Version | Row_format | Rows | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time         | Update_time | Check_time | Collation   | Checksum | Create_options | Comment |
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
| t1   | InnoDB |      10 | Compact    |   11 |        1048591 |    11534501 |               0 |            0 |         0 |             14 | 2024-02-13 07:15:27 | NULL        | NULL       | utf8mb4_bin |          | cached=on      |         |
| t2   | InnoDB |      10 | Compact    |   11 |        6291415 |    69205565 |               0 |            0 |         0 |             15 | 2024-02-13 07:36:10 | NULL        | NULL       | utf8mb4_bin |          | cached=on      |         |
+------+--------+---------+------------+------+----------------+-------------+-----------------+--------------+-----------+----------------+---------------------+-------------+------------+-------------+----------+----------------+---------+
2 rows in set (0.01 sec)

mysql> INSERT INTO t2 (text) VALUES (CONCAT(REPEAT('a', 6291400), 'xyz'));
ERROR 8242 (HY000): 'table too large' is unsupported on cache tables.
```